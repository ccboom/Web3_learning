# 以太坊 PoS (Gasper) 详解：Epoch, Slot, Attestation

> 学习资料：[ETH2 BOOK](https://eth2book.info/)

---

## 概述

Gasper 是目前 ETH 的共识协议，它结合了 **Casper FFG** 和 **LMD GHOST**。为了理解这个复杂的系统，我们先从最小的到最大的讲。

在 Gasper 设计中，验证者不只是简单的挖矿，而是通过**精准的定时**和**多维度的投票**来维持网络的一致性。

### 场景类比

我们现在想象一个场景：**小学写班级日志**

- 现在把 ETH 想象为一个班级
- 大家要共同维护一本班级日志：也就是区块链

---

## 第一部分：Slot（时隙）- 12秒

### 什么是 Slot？

**Slot = 轮到谁写一小段时间**

1. **时间限制**：老师手里有个表，12秒就会按一下，这个12秒，就算一个 slot
2. **谁来写**：在这个12秒内，老师会随机点名一位同学上来写
3. **做什么**：被点到的同学，要立刻跑到讲台，然后写下新的一行（比如写下刚刚谁交易了什么，这就是打包交易）

简单来说，**slot 就是给了一个人12秒的单独的时间来写日志**。

### 如果提议者掉线怎么办？

思考一种情况：正好老师点名了一个人小李，但是小李已经睡着了，不动弹，这时候：

- **A**. 12秒结束之后直接跳过小李，进行下一个人
- **B**. 全班一起冲上去帮助小李写日志

答案肯定是 **A**，一起冲上去不是乱套了吗？

在 ETH 中，如果选中的哪个写日志的人（验证者）掉线了或者没有反应，那个12秒 slot 就变成空白了，不会等他再上线或者怎么着，直接进入下一个12秒。这就是我们在区块链浏览器有时会看到 **Missed Block** 的原因。

---

## 第二部分：Epoch（时段）- 32个Slot（约6.4分钟）

### 什么是 Epoch？

**Epoch = 老师的检查周期**

如果每个12秒都要结算工资、发布任务，系统够呛能顶的住。所以 ETH 把32个 slot 打包成一组，叫做一个 **Epoch**。

你可以把 Epoch 想象为**时间长的课堂**。

### Epoch 的时长和功能

1. **时长**：大约6.4分钟，因为 12秒 × 32 = 384秒
2. **做什么**：在这个32个 slot 结束后，系统会进行一次大检查：
   - **发工资/罚钱**：刚刚那32个写日志的同学，写的好的发奖励，乱写的直接扣钱
   - **洗牌**：这一点最重要。系统会重新打乱所有验证者的顺序，随机安排下一个 Epoch 里的32个写日志的同学

### 日记本的类比

那么现在有一个问题，就只有32个 slot 吗？

对于一个 Epoch，是只有32个 slot：

1. **日记本的一页**：这个相当于一个 Epoch，每一页都只有32行
2. **每一行（slot）**：每一行就是一个 slot，只能写一个人的记录
3. **无限的页数**：当第32行写完后，这一页（Epoch）就结束了。但是我们马上翻到新的一页，从这一页第一行开始写（也就是下一个 Epoch）

### 为什么要随机抽签？

但是，但是，全校可不是只有32个写日志的学生！

全网验证者大概有100万个。你可以想象为一个学校学生都在等着写日志，一个 Epoch 的岗位只有32个。我们在这一个 Epoch 中，需要32个人站出来当提议者（也就是写日志）。

系统把这100万个人的名字放进一个巨大的摇奖箱中，从中抽取出下一个 Epoch 需要的32个人，安排到下一个 Epoch 的32个 slot 里面去。

**如果只有固定32个人，想想会发生什么？**

如果总是同一拨人记账，他们很容易串通起来造假。如果从100万人里面抽取，坏人根本不知道下一次轮到谁，也就无从下手！

---

## 第三部分：Attestation（证明/投票）

### 什么是 Attestation？

**Attestation = 其他同学的阅卷评分**

还是老场景中，在 slot 里，虽然只有一个人选中去台上写日志，但是，系统同时还会选中几千名同学在下面看。

这几千名同学的任务就是 **Attestation**。他们要看台上那个人写的对不对：

- 如果写的对：大家就投赞成票
- 如果写的不对：就投反对票或者无视
- 如果不投票：记作怠工，扣钱

简单来说，**slot 就是一个人写，Attestation 是一群人审核**。

### 区块链的核心逻辑

那么现在我们想一想：如果被选中写日志的是个捣乱鬼，他在日志写了一个假消息："老师欠我一个亿"，但是坐在台下的同学都是诚实的。那么这条假消息会被承认吗？

肯定不会！

**这就是区块链的核心逻辑：大多数人的诚实保证了账本的安全。** 只要诚实的同学占多数，那么捣乱的就不会通过，他写的日志就会被丢掉（成为孤块）。

### Attestation 的双重功能

那我们现在来看看 Attestation 到底是什么工作内容。你可能以为这些人只是简单的喊一句赞成或者反对，那就大错特错了，根本没这么简单。

你可以把它想象为一个**问卷调查**：

#### 1. 现在路走到哪了？（LMD GHOST 投票）

- **目的**：确定最新区块
- **场景**：比如现在两个同学抢着写日志了（分叉），你需要投票表示："A写的这个才是正统的"
- **作用**：决定了日志接下来写的时候接在谁后面写，这就是所谓的**分叉选择**

#### 2. 以前的账能不能锁死动不了了？（Casper FFG 投票）

- **目的**：确定最终性（Finality），也就是让交易永远无法撤销
- **场景**：这就是在说："我认为上一个 Epoch 以及之前的日志完全没问题，可以出版后面谁也不能改了"
- **作用**：目的是把历史**钉死**，防止有人改动以前的日志

### 投票的两个维度

总结一下：**每次投票其实是在做两件事情**：

1. **指路（LMD GHOST）**：告诉大家跟在谁后面写
2. **存档（Casper FFG）**：确定过去的哪些内容可以永久保存

### 分叉选择规则

现在思考一下这个问题：如果网络出现了分叉，验证者正在通过 Attestation 来决定选择哪一条。按照 Gasper 协议规定，应该选哪一条呢？

- **A**. 选最长的，包含投票权重最多的那条
- **B**. 选最新产生的，不管有没有人投票的那个

答案显而易见是 **A**。这就是 **LMD GHOST 核心逻辑**：**谁的票数最多，谁就是真正的主链**。

如果有两页日记同时写出来，大家会数一下哪个下面签名最多，最多的就是真日志，另一个则被作废。

---

## 第四部分：奖励机制 - 效率即安全

### 奖励规则

好了现在我们弄明白这些东西之后，那肯定会问，干活给多少钱？干的好给多少？干的不好扣多少？

在 ETH2 BOOK 奖励规则中，**速度非常重要**。

### 时间的重要性

我们想象一下：你是一个诚实的验证者，你在第6个 slot 看到一页新日志，并你也诚实的投出了赞成票，但是家里网实在太卡了，你投的票在6个 Epoch 之后才传上去。那么现在应该？

- **A**. 照样发全额奖励：只要内容是对的，迟到没关系
- **B**. 给一点辛苦费：迟到了，但是也做出了贡献，奖励少给点
- **C**. 直接判无效：过期不候，一毛没有

肯定是 **C** 呀！如果允许马后炮的话，那大家都看清楚哪边赢选哪边，这样就没人冒着风险维护网络安全了。这种在区块链有个专门的词叫**无利害关系**，这是这个问题的一个变种。

### Attestation 的保质期

在 Gasper 协议中，Attestation 是有保质期的：

1. **保质期很短**：一张票通常必须在1个 Epoch 内被打包上链
2. **过期作废**：像刚刚的例子，大家都投完了你才来，这时候早就翻篇了，你的投票对现在没有任何帮助

### Inclusion Delay - 速度奖励

现在又有一个问题了：现在有俩人，老王和老哈：

- **老王**：在第一秒就看到了区块，第二秒就投了正确的票并立马被打包了
- **老哈**：也看到了区块，投票也没问题，但是磨磨唧唧。到最后一刻（比如30个 slot）才把票打包

你觉得系统给他们奖励应该是一样的吗？

肯定是小王要拿的更多！**我们区块链的设计哲学：效率即安全**。

在 ETH 的奖励算法里，有一个重要的参数叫 **Inclusion Delay**：

- **快手老王**：如果他的投票在最早的 slot 打包，他能拿满额奖励
- **慢工老哈**：如果脱了好几个 slot 才被打包，他的奖励会大大减少

这就逼着全网验证者升级网速、优化硬件，大家都争先恐后的投票。从而让网络达成共识速度更快。

### 奖励的组成

奖励的组成不仅仅是快，其实奖励可以总结为**底薪加绩效**：

- **Source 投票正确**（为了确定 Casper FFG 检查点）：有奖
- **Target 投票正确**（为了确定 Casper FFG 检查点）：有奖
- **Head 投票正确**（为了确定 LMD GHOST 链头）：有奖
- **同步委员会奖励**（特殊的奖励，先不展开讲了）：有大奖

**只要你投对了，且足够快，那你就赚钱。**


---

## 第五部分：惩罚机制

### 两种不同的情况

赚钱的规则都知道了，那么该说说罚款了。我们干的不好，分为两种情况：

- **A**：由于张老三家里停电了，导致他一天没有发出任何投票（Attestation），离线了一天
- **B**：李老四为了恶意搞破坏，在同一个 slot 里面，先对 X 投了赞成票，又对 Y 投了赞成票（这叫双重投票，会导致网络分裂）

做了判官，你怎么看？

### ETH 的区分机制

ETH 把**无心之过**和**恶意攻击**分的非常清楚：

#### A：张老三属于怠工

在网络健康时，张老三只是没赚到钱，错过了 slot 奖励，就像请假没工资，但是不会扣钱。

如果全网 1/3 的人都掉线了，系统就会启动**怠工惩罚**。这时候张老三的余额就会被不断扣除，直到他余额低于16ETH被强制剔除。

这是一个**自动恢复机制**，踢掉不干活的人，让活人比例超过 2/3，网络就能回复正常。

#### B：李老四属于重罪

立马驱逐出验证者队伍，并强制扣除一部分 ETH（最低1ETH，最高可能是全部ETH）。

##### 连坐机制

这是最猛的，系统会同时看，有没有和李老四一起串通的人同时这么干：

- **没有**：罚的轻一点
- **有**：几千人同时搞，怀疑是有组织攻击，所有人的罚款呈指数级上升，直接罚到破产

---

## 第六部分：最终性（Finality）- 不可篡改

### 核心问题

最后一个，也是最神圣的：**Finality（最终性）**

我们要解决的核心问题是：**如何保证区块链的交易就像泼出去的水，永远收不回来？**

这就是 **Casper FFG 协议**的工作。他引入了一个类似于游戏存档的机制，也叫 **Checkpoint**。

### 检查点（Checkpoint）

- 每个 Epoch 有32个 slot
- 每个 Epoch 的第一个 slot 里的区块，就是这个 Epoch 的 checkpoint
- 所有验证者在投票时，不仅是选择现在的 Head，同时还要把票投给他们看到的最近两个 Checkpoint 之间的连接

### 两步走流程

#### 1. Justified（可信）

证明阶段，如果全网超过 2/3 验证者都给某个 checkpoint 投票了，那他就变的可信，我们叫他 **Justified**。

#### 2. Finalized（最终确认）

最终确认阶段，永久不可逆。

我们现在假设有相邻的 A 在前 B 在后的两个检查点：

- A 获得了 2/3 票，变成了 Justified（可信的）
- B 也获得了 2/3 票，变成了 Justified
- 当 B 被证明为可信的，因为他紧紧压住了 A，所以 A 就会变成 **Finalized**，把 A 彻底锁死

**一旦 A 变成 Finalized，包含在 A 之前的所有交易也就不能再次回滚了。**


---

## 总结

### 1. 时间架构：Slot 与 Epoch

以太坊的时间心跳，决定了谁来做事，多久结算一次。

| 概念 | 时长 | 定义 | 功能 |
|------|------|------|------|
| **Slot** | 12秒 | 区块链的最小时间单位 | 系统随机选出1名提议者负责打包交易 |
| **Epoch** | 约6.4分钟 | 32个Slot的集合 | 大洗牌、结算奖惩 |

### 2. 核心机制：Attestation (证明/投票)

这是保证区块链安全的关键，相当于全班同学的"阅卷"和"指路"。

**Attestation 的双重功能**：

- **LMD GHOST (指路)**：决定当下谁是主链（选票数最多的那条路）
- **Casper FFG (存档)**：决定过去哪些不可更改（对检查点进行投票）

### 3. 奖惩机制：效率即安全

系统通过经济激励，迫使验证者保持诚实且高效。

**奖励**：投得对 + 投得快 = 赚钱

**惩罚**：
- 怠工：拿不到奖励，严重时被踢出
- 作恶：立即踢出，扣除大量ETH，有组织攻击时罚款指数级上升

### 4. 最终性：Finality (不可篡改)

- **Checkpoint**：每个 Epoch 的第一个 Slot
- **Justified**：获得全网 2/3 投票
- **Finalized**：当新的 Justified checkpoint 紧跟在上一个 Justified 之后，前一个变成 Finalized

---

## 一句话总结 Gasper

**Gasper 是一个由 Slot 驱动节奏，通过 Attestation 投票（结合 LMD GHOST 选路和 Casper FFG 存档），利用 奖快罚慢、重罚作恶 的经济模型，最终达成全网 2/3 共识 从而实现交易不可逆转（Finality）的协议。**


---

## 参考资料

- [ETH2 BOOK](https://eth2book.info/)
