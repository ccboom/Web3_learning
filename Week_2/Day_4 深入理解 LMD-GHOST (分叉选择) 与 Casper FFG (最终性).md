# LMD-GHOST 与 Casper FFG 深入学习

> 延续昨天的学习，深入理解分叉选择与最终性

---

## 概述

- **LMD-GHOST**：处理**现在**和**未来**，在不断分叉的树枝上寻找最重的那根，主要看的是**速度（Liveness）**
- **Casper FFG**：处理**过去**，像是水泥工，把过去永久封存，主要看的是**安全（Safety）**

---

## 第一部分：为什么 Checkpoint 是第一个 Slot？

### 回顾 Checkpoint 的概念

昨天我们学了，Casper FFG 不会去管每一个细碎的区块，他的工作单位是 **Checkpoint**。

现在我们回顾一下：在一个包含32个 slot 的 Epoch 中，系统把**第一个 slot** 当作 Checkpoint，为什么呢？

### 投票的两个信息

想象一下你是一个验证者，被分配在 Epoch 的第6个 slot 投票。

你的投票包含2个信息：

1. **LMD-GHOST**：我明白了，现在最新的块是6号
2. **Casper FFG**：我确定这个 Epoch 的 target Checkpoint 是____?

### 为什么不能是中间的 Slot？

如果检查点是中间的 slot，你在第6个投票的时候，后面的方块还没诞生！

你无法给 Epoch 投票一个未来的东西，这就导致所有验证者得等待 Epoch 里面那个 Checkpoint 生成之后才能投票，大大降低了效率。

### 第一个 Slot 的优势

如果 Checkpoint 是第一个，你就可以说：**对的，那个就是我们这个 Epoch 的起点。**

实际上起到了两个作用：

1. **作为路标**：我们在修一个无限长的路，不需要每个砖块都验收一次，只需要隔32个砖设立一个里程碑
2. **处理空块**：如果恰好第一个 Slot 没人出块，这不是问题，系统会把最近的一个已有的区块视为这个 Epoch 的 Checkpoint，哪怕网络状况不好，每个 Epoch 也一定能找到一个代表

---

## 第二部分：绝大多数链接（Supermajority Link）

### 为什么需要 2/3 的阈值？

昨天说过了，为了让历史记录永久不可篡改，我们需要全网验证者对两个检查点之间的链接进行投票。这个行为被称为 **Supermajority Link（绝大多数链接）**。

最少需要 **2/3 的比例**才能视作大多数：

- **如果阈值是 51%**：恶意节点只要两头下注，就有可能让网络分裂成两个自己都认为合法的分叉
- **如果阈值是 2/3**：数学上决定了，除非有 >= 1/3 的验证者恶意双重投票，否则不可能出现两个冲突的绝大多数链接

---

## 第三部分：固化区块的两个步骤

### Justified 与 Finalized

既然我们需要 2/3 的票数来建立连接，那我们看看 Casper FFG 如何把这个利用起来固化区块的。

我们把固化区块的步骤分为两步：

1. **Justified**：目前看来没问题
2. **Finalized**：永远不可能改了

### 具体例子

我们有下面一个例子：

```
[检查点 A] ---> [检查点 B]
```

假设检查点 A 已经是 Justified 状态，如果全网 > 2/3 验证者投票支持从 A 接到 B，那么：

- **B 节点**就会变成 Justified
- **A 节点**就会变成 Finalized

就好比攀岩，把一只手伸向了 B 点并抓牢时，A 点就成为了绝对安全的支撑点。

---

## 第四部分：经济确定性 vs 概率性最终性

### 假设场景

如果：现在 99% 的验证者突然反悔了，他们想把历史回滚到 A 之前，于是他们私下制造了一条不包含 A 的链，比现在的链还要长，还要重。

那么系统应该：

1. **遵守最重链规则**：因为新链权重更高，所以切换到新链
2. **遵循最终化优先**：既然 A 已经被最终化，无论新链多重，直接无视

### ETH 的选择

ETH 客户端会选择**第二个答案**，这就是**以太坊 PoS 和 BTC PoW 最本质的区别**：

#### BTC：概率性最终性

- 遵循最长链规则
- 理论上只要算力足够大，哪怕是100个区块的历史也可能被篡改

#### ETH：经济确定性

- 一旦区块被 Finalized，客户端就会无视任何与该区块冲突的链，哪怕再长再重也不行
- 如果有人想推翻已经 Finalized 的区块，那他们必须让全网 1/3 的验证者违背规则进行双重投票
- 这会导致这些验证者的押金 ETH 被罚没（Slashing）
- 意味着攻击成本高达数十亿，并且注定会失败（因为诚实的客户端会自动拒绝那条攻击链）

---

## 第五部分：罚没条件（Slashing Conditions）

### 为什么需要罚没条件？

为了保证这一套逻辑成立，Casper FFG 给验证者定下必须遵守的规则。一旦违反就会触发罚没。

### 规则1：双重投票（Double Vote）

最直观的规则叫：**Double vote（双重投票）**

在一个 Epoch 里面，对同一个 slot 的两个不同区块分别投了票。

这就像你在同一时刻对两群不同的人说了两个相互矛盾的谎言，这会直接导致网络分裂。一旦被发现，你的 ETH 就会被罚没。

### 规则2：环绕投票（Surround Vote）

还有一条：**Surround Vote**

如果说双重投票是当面胡说，那么这个规则就是防止暗度陈仓。

#### 具体例子

比如下面的例子：

**投票 A (短线)**：
- 源头（Source）是 Epoch 2
- 目标（Target）是 Epoch 3
```
Epoch 2 ---> Epoch 3
```

**投票 B (长线)**：
- 源头是 Epoch 1
- 目标是 Epoch 4
```
Epoch 1 ---------------------> Epoch 4
```

仔细一看的话，投票 B 的范围（1-4）完全包含了投票 A 的范围（2-3）。

#### 为什么这是问题？

它试图掩盖历史。想象一下：

- 我们已经达成了共识：Epoch 2 是 Epoch 3 的父节点
- 突然有个人出来说，Epoch 1 直接链接到 Epoch 4，跳过了 2 和 3

如果系统接受了这张票，就相当于在同一时间线上创造了两个平行的事实。

#### 防止措施

为了防止这种情况，Casper FFG 规定：**任何两个投票的连线不能发生交叉或者包含关系。**

---

## 总结

### LMD-GHOST (短期)

也就是**分叉选择**。像贪吃蛇一样，总是朝着票数权重最重（Greediest）的方向前进，保证链一直往前走（Liveness）。

### Casper FFG (长期)

也就是**最终性**。像打桩机一样，每隔一段距离（Epoch）就打下一个检查点。

- **第一锤**：Justify（证明）
- **第二锤**：Finalize（最终化）

### 连接点

**LMD-GHOST 总是站在最新的 Justified 检查点（第一锤）上，去寻找下一个区块。**

---

## 关键概念速查

| 概念 | 说明 |
|------|------|
| **Checkpoint** | 每个 Epoch 的第一个 Slot，作为路标 |
| **Justified** | 获得 2/3 投票支持，目前看来没问题 |
| **Finalized** | 被下一个 Justified 检查点压住，永久不可改 |
| **Supermajority Link** | 两个检查点之间的 2/3 投票连接 |
| **Double Vote** | 在同一 Epoch 对同一 Slot 的两个不同区块投票（违规） |
| **Surround Vote** | 投票范围包含另一个投票范围（违规） |
| **Slashing** | 违反规则导致的 ETH 罚没 |
| **经济确定性** | 一旦 Finalized，攻击成本极高且注定失败 |
