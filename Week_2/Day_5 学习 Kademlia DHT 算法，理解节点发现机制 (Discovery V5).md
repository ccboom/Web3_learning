# Kademlia DHT 算法与节点发现机制

今天学习 Kademlia DHT 算法，理解节点发现机制 (Discovery V5)

今天我们来深入 P2P 网络的核心。Kademlia DHT（分布式哈希表）是去中心化网络节点互相发现的基石，ETH 的节点发现协议（Discovery 5）正是建立在这个基础上的。

---

## 第一部分：距离的定义

### 逻辑距离 vs 物理距离

在现实世界里，我们用米或者千米来衡量距离；但是在 Kademlia 的数字世界中，我们用**逻辑距离**。

这个逻辑距离不是看物理距离，而是看两个节点的 ID（身份标识）有多像。

Kademlia 使用**异或 XOR** 来计算这个距离。

### XOR 运算规则

- 两个位相同，结果为 0，表示比较近
- 两个位不同，结果为 1，表示比较远

### 实例计算

我们举一个简单的例子：

- 如果节点 A 为 `1 0 1`
- 如果节点 B 为 `0 1 1`

那他们的距离是？

我们使用异或来竖直比较，得出来的结果为 `1 1 0`，十进制就是 4 + 2 + 0 = **6**

所以在 Kademlia 网络中，节点 A 与 B 的逻辑距离就是 6。

想想如果反过来，B 与 A 的距离是多少？也是 6，这就是 XOR 算法作为距离度量的一个特性：**对称性**。

在 P2P 网络中，如果我觉得你离我比较近，那么你也一定觉得我离你比较近，这意味着链接和路由表是双向互惠的。

### 三角不等式

除了对称性，XOR 距离还有一个让他成为完美度量的关键特性：**三角不等式（Triangle Inequality）**。

简单来说就是，直接去某地的距离，一定比绕远路去某地更少或者相等。

$$d(A, C) \le d(A, B) + d(B, C)$$

这个公式至关重要，它保证了我们在查找节点的时候是**收敛**的，不是在一个圈子里面乱兜风。

### 验证三角不等式

我们延续上面的例子：

- 如果节点 A 为 `1 0 1`
- 如果节点 B 为 `0 1 1`
- 如果节点 C 为 `0 1 0`

已知 $d(A, B) = 6$

那么我们可以算出来：

$$d(B, C) = 001 = 1$$
$$d(A, C) = 111 = 7$$

我们带入公式得：

$$d(A, C) \le d(A, B) + d(B, C)$$
$$7 \le 6 + 1$$
$$7 \le 7$$

公式成立！这个数学性质保证了我们在寻找节点的时候，每一步跳转都会收敛，越来越接近目标，绝对不会在网络里面绕圈子。

---

## 第二部分：路由结构 - K-桶（K-Buckets）

### 亲疏有别的策略

在一个有几百万网络节点的网络中，我们不可能存储所有网络的信息，这会耗费巨大的内存。Kademlia 的策略是：**亲疏有别**

- **离我近的**：我存的非常详细，甚至每个人都存
- **离我远的**：我存几个能联系上就行了

### K-桶的分层

我们按照 2 的幂次方切分成不同的等级（Bucket），假设还是 3 位 ID，你是节点 `000`，那么你路由表有 3 个桶：

1. **Bucket 0**：距离为 $[2^0, 2^1)$ 也就是 1 的节点
2. **Bucket 1**：距离为 $[2^1, 2^2)$ 也就是 2 到 3 的节点
3. **Bucket 2**：距离为 $[2^2, 2^3)$ 也就是 4 到 7 的节点

如果现在有一个节点 `1 1 0`，那么应该放到哪个桶里？

`1 1 0` 距离我们 `0 0 0` 是 6，所以应该放到 2 号桶里，没毛病。

### 为什么要这样分桶？

比如我们现在在公司里：

你对同一个公司的人，可能认识很多，但是你对另外一个城市的分公司的人，可能只认识一两个联络的。

当你要找一个分公司的人的时候，你不需要直接认识他，你只要找到你认识的，他肯定一般都认识。

这种机制保证了我们每一步跳转，大概都能把剩下的距离至少缩短一半。

### 对数时间复杂度

如果我们在拥有 N 个节点的网络中，找到一个任意节点大概要多少步？

这种每次砍掉一半的查找效率，我们在计算机科学里面叫做**对数时间复杂度** $O(\log N)$。

这就是 Kademlia 最强大的地方：网络的规模变大了，但是查找的速度几乎不变。

### 对数刻度的魔力

如果现在的网络节点突然翻了一倍 $N \to 2N$，那么我们查找一个节点需要的步骤会多几步？

- A 增加一步
- B 增加 1000 步
- C 增加一倍

根据公式我们可以得出来，选 **A**。

这就是对数刻度（Logarithmic Scale）的魔力：网络规模翻倍，查询成本只增加一步，这就是为什么 ETH 这种全球性的网络能在几秒内完成节点发现，而不是几分钟。

---

## 第三部分：ETH Discovery V5 (DiscV5) 协议

### 原始 Kademlia 的局限

在原始 Kademlia 中，节点只要能找到对方就行了，但是在 ETH 中，我们光找到 IP 地址还是不够的，我们还需要知道这个节点是不是在同一个链上，或者它有没有我们想要的功能，比如它是不是一个轻节点？

这就引入一个新的概念：**ENR (Ethereum Node Record）**

其实 ENR 就是一张超级名片，以前的 Kademlia 只有电话号码，但是现在的 DiscV5 交换的是一张签了名的名片。

### TCP vs UDP 的选择

为了让这个交换名片的过程尽可能快而且不占用太多带宽，我们选择底层通信时是选择 TCP 还是 UDP？

#### TCP（传输控制协议）

- **就像挂号信一样**：寄出去的信，必须对方签名确认收到才算完，如果没有回执，我会一直寄一直寄
- **讲究顺序**：如果你寄了 1/2/3 三封信，TCP 保证对方一定按 1 2 3 的顺序读到，绝对不会乱
- **建立连接**：在发信之前还得打电话确认，你在家吗？我要寄信了（这就是著名的三次握手）
- **缺点**：规矩太多，所以就慢了，占用资源也多

#### UDP（用户数据报协议）

- **就像扔纸飞机**：写好了地址直接扔出去，对面收到了吗？信丢了没？统统不管，反正已经发了
- **简单粗暴**：不需要建立连接，也不用确认，发出去顺序乱了也不管
- **优点**：速度快，没有过多的手续确认

### 为什么选择 UDP

看到这我相信你能理解使用哪个了，那就是使用 **UDP**，主打一个快和轻量。

因为节点需要频繁的发送小数据包，每次要用 TCP 三次握手的话太慢了。

我不关心你能不能接到，我只关心我能不能在短时间发给更多的人，偶尔丢了一两个包也没什么影响。

### ENR 的内容

那我们现在知道了这个之后，再看看名片 ENR 里面有什么：

1. **IP 地址和端口**：必须有它，没有它就像名片没电话，根本联系不上
2. **节点类型**：我们通常使用键值对来存储，是轻节点还是全节点？支持哪些协议？这样在别人找特定的服务时，一看名片就知道了，不用浪费时间建立连接
3. **身份验证**：我们放的是公钥，因为名片上还有我们的签名，我们可以用公钥来验证签名

### 防篡改机制

接下来看一个场景：

如果有一个黑客把我们的 ENR 截获了，换上了它自己的 IP 地址，别人怎么知道他是伪造的呢？

就是使用公钥来验证。在 DiscV5 协议中，ENR 不仅包含了信息，还包含了一个发布者用私钥发布的签名。

黑客修改了 IP 地址，但是它没有你的私钥所以没办法生成新的签名。只能保留你旧的签名。

别的节点收到之后，使用公钥去验证签名，计算结果当然不会相同，hash 值因为雪崩效应改变了。所以别的节点不会记录这个 ENR，这通常被称为**丢弃的数据包（Packet Drop）**。

既然签名验证失败，节点就会直接忽略这条信息，既不回复，也不更新 K 桶，直接扔到垃圾桶里。

---

## 总结

### 1. 核心度量：XOR 逻辑距离

**定义**：在数字世界中，距离不由物理位置决定，而是由节点 ID 的异或 (XOR) 运算结果决定。

**特性**：
- **对称性**：A 离 B 的距离等于 B 离 A 的距离，保证了路由的双向互惠。
- **三角不等式**：直达永远不比绕路远（ $d(A,C) \le d(A,B) + d(B,C)$ ）。这一数学性质保证了查找过程是收敛的，绝对不会在网络中死循环。

### 2. 路由结构：K-桶 (K-Buckets) 与对数效率

**分桶策略**："亲疏有别"。距离越近（Bucket 序号越小），记录越详细；距离越远，记录越稀疏。

**查找效率**：利用二分查找的逻辑，每一步跳转都能排除网络中一半的节点。

**扩展性**：时间复杂度为 $O(\log N)$ 。网络规模翻倍（ $N \to 2N$ ），查找路径仅增加 1 步。这解释了为什么以太坊这种全球网络能实现秒级节点发现。

### 3. 落地实现：ETH Discovery V5 (DiscV5)

**通信协议**：选择 UDP 而非 TCP。因为节点发现需要高频、轻量的"打招呼"，不需要 TCP 繁琐的握手和严格的顺序，主打一个"快"和"丢包也没关系"。

**超级名片 (ENR)**：相比原始 Kademlia 只存 ID/IP，ETH 的 ENR 包含了更多信息：
- **键值对**：标识节点类型（全节点/轻节点）、支持的协议等。
- **安全性**：包含公钥和数字签名。
- **防篡改机制**：任何对 ENR 内容（如 IP）的篡改都会导致签名验证失败（哈希雪崩效应）。接收方验证签名失败后会直接丢弃数据包，从而防止恶意节点的欺诈。

### 一句话总结

Kademlia 利用 XOR 距离和 K-桶实现了在海量节点中 $O(\log N)$ 级的高效查找，而 ETH 的 DiscV5 协议在此基础上，通过 UDP 和带签名的 ENR，构建了一个既高速又安全的去中心化节点发现网络。
