# 经典漏洞：预言机操纵 (Oracle Manipulation)

今天继续学习一个非常经典的 DeFi 案例，既包含了闪电贷的利用，也涉及了复杂资产的定价难题。

简单来说，**预言机操纵 (Oracle Manipulation)** 就像一个人在参加考试，但是他把标准答案换了，导致老师给出了错误的分数。在 DeFi 中，攻击者会通过短暂的剧烈波动来欺骗协议，让其误以为攻击者的抵押品非常值钱。

**Warp Finance** 的被盗事件发生在 2020 年 12 月，它之所以特殊，是因为它接受的抵押品不是普通的代币，而是 Uniswap 的流动凭证 **LP Token**。

## LP Token 的定价逻辑

我们先来讲讲 LP Token 的定价逻辑。你可以把 Uniswap 想象为一个天平。LP Token 就是你在这个池子的收据，这张收据的价值取决于它代表池子里的资产的总价值。

假设我们有一个 **DAI-USDC** 的流动池：

1.  **池内资产**：现在有 1000 DAI 和 1000 USDC。
2.  **资产价格**：假设每个 DAI = $1，USDC = $1。
3.  **LP Token 的总量**：发行的 LP Token 也是 1000 个。

**那么现在一个 LP Token 值多少钱？**

因为我们现在池子总价值是 $1000 + 1000 = 2000$。
但是 LP Token 总量是 1000，所以：
$$1 \text{ LP Token} = \frac{2000}{1000} = 2\$$$

Warp Finance 当时就是采用了这种看似合理的结构：它去读取池子里有多少个币，然后乘以这些币的预言机价格（比如 Chainlink 给出的 $1），加起来作为总价值：

$$\text{池子总价值} = (\text{池内DAI数量} \times \text{DAI全球价格}) + (\text{池内USDC数量} \times \text{USDC全球价格})$$

但是 Uniswap 使用的是另一个核心公式：$X \times Y = K$，这意味着当你在这个池子里交易的时候，两种代币的数量乘积必须不变。在这个例子里就是 $1000 \times 1000 = 1,000,000$。

## 攻击演示：制造虚假价值

现在好戏开场了：

假设攻击者利用闪电贷，向池子里倒入了大量的 DAI，换走了 USDC，导致池子严重倾斜。

现在池子变成了：
*   **DAI**：4000 个
*   **USDC**：250 个
*   $4000 \times 250 = 1,000,000$，符合 Uniswap 规则。

但是现在 Warp Finance 的预言机依然认为 $1 \text{ DAI} = 1\$$, $1 \text{ USDC} = 1\$$。

这时候我们再用 Warp Finance 的逻辑算一下，池子里的总资产价值变成了多少？
$$4000 + 250 = 4250\$$$

这时候就面临一个非常荒谬的情况：
*   **实际上**：池子还是那个池子，只是里面的币比例严重失衡了。
*   **Warp 视角**：因为它简单粗暴的将币的数量乘以 $1 的外部价格，它认为这个池子从 $2000 暴涨到了 $4250。

这就是**预言机攻击的核心**——利用错误的定价公式制造资产虚高的假象。

### 攻击者的获利

接下来我们就要看看攻击手法了。攻击者现在手里有这些 LP Token 作为抵押品。

从哪借钱呢？还是从 Warp Finance 里面。Warp Finance 就像一个银行，允许用户存取 LP Token 作为抵押品，然后借出稳定币，比如 DAI。

Warp Finance 的规则是：你最多可以借出抵押品价值的 **75%** 的资金。

*   那在这个虚高的报价下，如果攻击者拥有全部的 LP Token，他能从协议里借出多少钱？
    $$4250 \times 0.75 = 3,187.5\$$$
*   但是 $2000 的池子本应该借多少钱？
    $$2000 \times 0.75 = 1500\$$$

我们本应该最多只能借出来 $1500，但是现在却能借出来 $3187.5！

抵押在里面的东西实际只值 $2000。协议借了 $3187.5 给我们，我们就算不还钱直接跑路，那还有 **$1187.5 的差价**！这就是攻击者的利润来源。

## 攻击者的武器：闪电贷 (Flash Loan)

我们要实现上面的魔法，前提是必须往池子里倾倒海量的资金，来达到不平衡。刚刚的例子是几千个 DAI，但是现实中则是几百万美元。

如果攻击者是个穷光蛋，没钱咋办？这时候就轮到 **闪电贷 (Flash Loan)** 出场了。

闪电贷是区块链世界中特有的一种金融工具，它和我们在现实生活中去银行借钱完全不同。它有两个特点：

1.  **无需抵押**：你不需要提供任何资产作为抵押，你只要是个会写代码的人，就可以借。
2.  **原子性**：这是最厉害的地方，**借款/使用资金/还款必须在同一个交易中瞬间完成**。

这就像一种魔法：你借钱的一瞬间你可以暂停时间，借了 1 亿美元，用这个钱去各个市场倒卖差价。如果你赚到了钱，把这 1 亿还回去，给点手续费，剩下的利润归你；如果操作失误还不上，那么魔法失效，时间就会倒流，像这个借款从未发生过一样。

这对于借出资金的协议来说风险也极低，如果因为借款人不还钱，这笔借贷根本就不会成立。

这样黑客手里就有资金了。

## 完整攻击流程

接下来操作流程是这样的：

1.  **获得巨款**：通过闪电贷借入了巨额的 DAI。
2.  **操纵天平**：将借来的 DAI 一股脑地倒进 Uniswap 池子，换走了里面的 USDC。
3.  **蒙蔽双眼**：这时，Warp Finance 协议通过预言机来查看池子的价值，结果发现池子里有巨量的 DAI，但是还是依照公式计算出巨量的池子价值。
4.  **满载而归**：黑客利用这个瞬间暴涨的虚假身份作为抵押，从 Warp Finance 借出了大量的稳定币。
5.  **全身而退**：黑客用借来的钱换回代币，归还闪电贷本金和手续费。剩下的钱，就是利润。

这一切都发生在一个区块中，快到没人能反应过来。黑客通过重复这个过程，最终卷走了 **770 万美金**。

## 修复方案：基于 K 值的公平定价 (Fair LP Pricing)

既然我们看透了这个漏洞，假如你现在是 Warp Finance 的安全顾问，需要修复这个漏洞。

问题就出现在公式中的 **池内代币数量** 太容易被篡改了。

如果我们要设计一个不受闪电贷倾倒资金影响的定价公式，你觉得应该用什么来推算？
没错就是：**Uniswap 公式中的 K** ($X \times Y = K$)。

代币的数量 X 和 Y 会剧烈波动，但是池子里的真实流动性深度不会增加。在 Uniswap 机制中，只有真正有人存入资金，也就是 `addLiquidity` 的时候，K 值才会增加。仅仅是交易，K 值理论上还是保持不变的。

所以，聪明的协议会使用下面的公式进行计算：

$$\text{公平总价值} = 2 \times \sqrt{K \times P_{\text{DAI}} \times P_{\text{USDC}}}$$

这里的关键是 **K 是不变或者变化极小的**，攻击者无法通过瞬间交易拉高它。外部价格是通过预言机给的全球公允价格，也没变。

那让我们带入刚刚那个场景中看看：

*   **攻击前**：$K = 1,000,000$，$P=1$。
    $$\text{价值} = 2 \times \sqrt{1,000,000 \times 1 \times 1} = \mathbf{2,000} \text{ (正常)}$$
*   **攻击后**：攻击者把池子搞成了 4,000 DAI 和 250 USDC。但是！$K$ 依然是 $1,000,000$ (因为 $4000 \times 250 = 1,000,000$)。
    $$\text{价值} = 2 \times \sqrt{1,000,000 \times 1 \times 1} = \mathbf{2,000} \text{ (防御成功！🛡️)}$$

看到魔法了吗？无论攻击者把池子里的代币比例扭曲得多么离谱，只要 $K$ 没变，算出来的总价值依然是稳稳的 2000 美元。攻击者没法借出更多的钱，攻击也就失效了。

## 总结

1.  **预言机操纵** 是 DeFi 中最常见的攻击手段之一，核心在于利用市场（特别是 AMM 池子）瞬时的流动性不平衡，欺骗协议对资产的定价。
2.  **LP Token 定价** 不能简单依赖 `Token A 数量 * Price A + Token B 数量 * Price B`，因为代币数量极其容易被闪电贷瞬间扭曲。
3.  **闪电贷** 极大地降低了攻击门槛，提供了几乎无限的资金弹药，让攻击者可以轻易撼动流动性池。
4.  **防御的核心** 在于寻找“不变量”。在 AMM 模型中，$K$ 值（恒定乘积）是衡量流动性深度的核心指标，不易被交易改变。使用基于 $K$ 值的定价公式 ($\text{FairAssetValue} = 2 \times \sqrt{K \times P_1 \times P_2}$) 是针对此类攻击的标准防御方案。
