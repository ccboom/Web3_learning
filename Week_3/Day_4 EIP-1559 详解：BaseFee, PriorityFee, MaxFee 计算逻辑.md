# EIP-1559 与以太坊交易费用机制

我们慢慢来拆解 EIP-1559。

EIP-1559 将以太坊的交易费用市场从简单的**竞价拍卖**变成了**可预测的机制**。

你可以把它想象为网约车：系统有一个基础路费（BaseFee），你可以选择给司机小费（PriorityFee），同时你也可以设置一个最高的心里价位（MaxFee）。

我们拆开看看这三个概念。

---

## 第一部分：三个费用概念

### 1. BaseFee（基础费）- 起步价

这是系统规定的，你**必须支付**的最低费用。

这不是司机（矿工），也不是你决定的，而是通过当前的网络繁忙程度**自动计算**的。

这部分钱会被**销毁**，就像是平台抽成，不给任何人，直接消失。

### 2. PriorityFee（优先费）- 给司机的小费

这是为了让司机（矿工/验证者）快点来接你给的小费。

完全由你自己决定给多少，给出的全部给了矿工/验证者。

因为 BaseFee 销毁了，矿工拿不到，如果没有小费，矿工不会优先打包你的交易。

### 3. MaxFee（最大费用）- 你的预算上限

这是你为了这趟行程花的**绝对上限**。

它保护你的钱，不论怎么走都不会超过这个钱。

比如：你在叫车的时候设置了最高一百块，那么如果坐车要 120，系统就不会派车给你。如果只要 50，那么系统就会花 50 元。

### 最人性的地方

EIP-1559 最人性的地方在于，你设置了 MaxFee，但不代表你要花那么多钱。

$$\text{实际花费} = \text{BaseFee(起步价)} + \text{PriorityFee（小费）}$$

剩下的钱会自动退还给你：

$$\text{退款} = \text{MaxFee} - \text{实际花费}$$

---

## 第二部分：BaseFee 调整机制

EIP-1559 的魔法在于，BaseFee 不是人们一拍脑袋决定的，而是**完全由区块的拥挤程度决定**。

### 目标填充率

以太坊设置了一个完美目标，区块最好只装 **50% 的东西**（目标 gas 用量是 1500 万）。

- **如果区块太满（>50%）**：说明想上车的人太多，系统会自动提高下一个区块的 BaseFee
- **如果区块太空（<50%）**：说明想上车的人太少，系统会自动降低下一个区块的 BaseFee

就好比地铁，如果人挤人的话，下一趟车自动涨价 12.5%，如果上一趟车空空的，这一趟就降价。

### 指数级暴涨

我们来想想，假设网络变得超级拥堵，好几个区块都塞得满满当当，你觉得 BaseFee 会发生什么变化？

如果区块连续被塞满（100%），BaseFee 每个区块（12 秒）就会上涨，这听起来不多，但是仅仅过 20 个区块，BaseFee 就会暴涨 **10 倍**！

---

## 第三部分：当预算不够时

想象一下，当网络及其拥堵，BaseFee 飙升到了 150，但是，我们发送交易比较保守 MaxFee 设置了 140。

现在会发生什么？

- **A**：交易成功，但是只扣 140，给你打折
- **B**：交易失败并退回（Revert）
- **C**：交易发不出去，一直卡在处理（Pending），直到 BaseFee 降下来

**答案是 C**，这种情况在以太坊经常发生，我们称之为**交易卡死**。

### 为什么？

**硬性规定**：协议层要求 MaxFee 必须大于等于 BaseFee。

就像坐地铁，现在地铁票 150，但是你说你出 140，闸机不给你过，等什么时候降到 140 了，闸机就给你同行。

---

## 第四部分：Transaction Payload

简单来说，**Transaction Payload** 指的是一笔交易或数据传输中，实际承载的核心数据或具体的指令内容，在代码中对应 `data` 或 `input` 字段。

### 信件的比喻

我们把交易想象成一封信：

- **信封**：写着发件人，收件人，贴了邮票（Gas fee）
- **里面**：放着信写着内容，这就是 payload

### Payload 的三种用途

#### 1. 转账 ETH

如果你只想转账，那么 payload 就是 `0x` 或者是空。

#### 2. 发送消息（链上留言）

你可以把一段文字转换为 16 进制写进去。

例子：`0x68656c6c6f` (这是 "hello" 的十六进制)

接收者的钱包虽然看不懂这是什么指令，但这串数据会永远留在区块链上。

#### 3. 调用智能合约（最核心的情况）

这是以太坊作为世界计算机的精髓。当你在 DEX 上买币，或者去铸造一个 NFT 的时候，payload 是一串很长的十六进制代码，它其实是一条明确的指令。

比如你想调用一个合约里的 `transfer` 函数，payload 可能长这样：

```
0xa9059cbb000000000000000000000000abc...
```

### Payload 的两个关键部分

| 部分 | 十六进制示例 | 作用 |
| :--- | :--- | :--- |
| **函数选择器** | `0xa9059cbb` | "我要做什么"。它是函数名(比如 transfer)的哈希值的前 4 位。告诉合约去运行哪一段代码。 |
| **参数数据** | `000...abc` | "具体细节是什么"。比如转给谁、转多少。这些数据跟在后面，每 32 字节一段。 |

### Payload 长短与 Gas 费用

那么你觉得 payload 长短，会影响你的 gas 费用吗？

**当然是会的**。在以太坊里面，每一个字节的数据都需要全球节点去处理，他们都是明码标价的，我们把这称为**数据费（Data Cost）**。

这好比卡车运货，货物越重（Payload 越大），油耗越高（gas 越贵）。

### 数据费计价

一般是这样计价的：

- **非零字节**：比如 `0x12`、`0xab`。这是实打实的货物。很贵，需要 **16 Gas/字节**
- **零字节**：`0x00` 这是空箱子，好压缩，比较便宜，只要 **4 Gas/字节**

---

## 第五部分：终极计费公式

当你发送一笔交易时，你最终支付的 ETH 是这样算的：

$$\text{总费用 (ETH)} = \text{Gas数量 (Quantity)} \times \text{Gas单价 (Price)}$$

我们将它拆解开来：

### 1. Gas 数量（Quantity）

- **起步费**：21,000 GAS
- **数据费**：payload 成本，比如 20 Gas
- **执行费**：调用合约，还要加上合约代码的运行消耗（EVM 里的计算）

**例子**：21,000 + 20 = 21,020 GAS

### 2. Gas 单价（Price）

就是我们在 EIP-1559 里面学的：BaseFee + PriorityFee

**例子**：50 Gwei + 2 Gwei = 52 Gwei

---

## 总结

### 1. EIP-1559 费用市场：像网约车一样的定价机制

EIP-1559 将费率从"盲拍"变成了"可预测"模式，由三个部分组成：

#### BaseFee（基础费/起步价）

- **性质**：系统根据网络拥堵程度自动计算的最低费用。
- **去向**：全部销毁（Burn），不给矿工。
- **调节机制**：锚定区块 50% 的填充率。
  - 区块 > 50% 满 → 下个区块 BaseFee 上涨（连续拥堵可导致指数级暴涨）。
  - 区块 < 50% 满 → 下个区块 BaseFee 下跌。

#### PriorityFee（优先费/小费）

- **性质**：给矿工/验证者的激励，决定打包的优先级。
- **去向**：全归矿工。

#### MaxFee（最大费用/心理价位）

- **性质**：用户愿意支付的最高上限，保护用户不受价格波动影响。
- **结算**：实际花费 = BaseFee + PriorityFee。
- **退款**：退款 = MaxFee - 实际花费。

### 2. 当预算不足时：交易卡死（Pending）

- **场景**：网络拥堵导致 BaseFee 暴涨，超过了你设置的 MaxFee。
- **结果**：交易状态为 Pending（卡死）。
- **特点**：交易不会失败（Revert），也不会扣钱，而是被滞留在交易池中。
- **硬性规定**：只有当 BaseFee 降回到你的 MaxFee 以下时，交易才会被处理。

### 3. Transaction Payload：交易的核心载荷

Payload 是交易中承载具体指令的数据（Data），决定了交易的用途：

**三种用途**：

- **普通转账**：Payload 为空或 `0x`。
- **链上留言**：存放十六进制的文本数据。
- **调用智能合约**：最核心功能。

**结构**：函数选择器 (前 4 字节) + 参数数据 (每 32 字节一段)。

**数据成本（Data Cost）**：

- Payload 越长，Gas 越贵。
- **非零字节**：16 Gas/字节（贵）。
- **零字节**：4 Gas/字节（便宜）。

### 4. 终极计费公式

以太坊交易的总花费由"用了多少资源"乘以"资源的单价"决定：

$$\text{总费用 (ETH)} = \text{Gas数量 (Quantity)} \times \text{Gas单价 (Price)}$$

**Gas 数量 (Quantity) =**

- 基础费 (21,000)
- 数据费 (Payload 大小及零/非零字节分布)
- 执行费 (运行智能合约代码的消耗)

**Gas 单价 (Price) =**

- BaseFee (销毁) + PriorityFee (给矿工)
